这是一份整理好的完整项目设计文档。你可以直接将其用于项目提案、技术评审或作为开发团队的指导手册。

---

# KONG CUBE 智能组态生成与编排系统设计文档

**版本**：1.0  
**日期**：2023-10-XX  
**适用对象**：系统架构师、开发工程师、项目管理者

---

## 1. 项目背景与目标

### 1.1 背景
**KONG CUBE 开发者中心**是美的楼宇科技推出的开放技术平台，旨在构建“中国人自己的智慧建筑操作系统”。平台提供了基于功能块（Function Blocks）的可视化编程与组态工具，涵盖变量、数学运算、逻辑运算及定时/累计等应用模块。

目前，工程师在设计复杂的控制逻辑（如“夏季主机初始开启台数计算”）时，需要手工拖拽模块、连线并配置参数。这一过程存在以下痛点：
*   **效率低下**：手工操作耗时，尤其是面对重复性逻辑时。
*   **依赖经验**：由于模块众多，找到最优组合方案依赖工程师的个人经验。
*   **易出错**：连线逻辑和参数配置容易出现人为疏忽。

### 1.2 项目目标
构建一个基于 **LangGraph** 的多智能体（Multi-Agent）系统。该系统能够理解用户的**自然语言需求**，自动拆解任务，调用知识库，生成符合 KONG CUBE 标准的 **JSON 组态文件**。

核心价值在于：**从“人工组态”向“语义化自动生成”转变，大幅提升楼宇自控系统的开发效率与标准化程度。**

---

## 2. 核心技术策略：中间层优先 (DSL Strategy)

鉴于直接生成复杂的 JSON 图结构（包含随机 ID、坐标、嵌套连线）对大模型极具挑战且不稳定，本项目采用 **“代码即组态” (Configuration as Code)** 的策略。

*   **不直接生成 JSON**：避免 LLM 处理 UUID 和复杂的拓扑结构。
*   **生成 Python 中间代码**：智能体生成基于 SDK 的 Python 代码，该代码具有严谨的语法结构和可执行性。
*   **编译输出**：通过 Python SDK 的编译器，将代码自动转换为合法的 KONG CUBE JSON 文件。

---

## 3. 技术架构设计

系统采用分层架构，基于 **LangGraph** 实现智能体的编排与状态管理。

### 3.1 架构分层

| 层级 | 名称 | 描述 | 关键组件 |
|:---|:---|:---|:---|
| **L1** | **交互层 (Interaction)** | 用户入口与可视化 | Streamlit/Chainlit, 自然语言输入框, 流程图预览 |
| **L2** | **编排层 (Orchestration)** | 状态管理与路由 | **LangGraph**, StateGraph, 条件边缘 (Conditional Edges) |
| **L3** | **能力层 (Capabilities)** | 具体的智能体节点 | Retrieval Agent, Planning Agent, Coding Agent, Validation Agent, Debugging Agent |
| **L4** | **基础设施层 (Infra)** | 底层工具与模型 | **Kong SDK (Python)**, 向量数据库 (ChromaDB), LLM (可插拔模型接口，支持主流大模型) |

### 3.2 智能体工作流 (DAG)

系统是一个包含反馈闭环的有向图：

1.  **Start** -> 检索 (Retrieval)
2.  检索 -> 规划 (Planning)
3.  规划 -> 编码 (Coding)
4.  编码 -> **代码执行沙箱 (Execution)**
5.  执行 -> **验证 (Validation)**
    *   *Pass* -> 结束 (End) / 人工审核
    *   *Fail* -> **调试 (Debugging)**
6.  调试 -> 重新编码 (Coding Loop)

---

## 4. 智能体组成与职责详解

### 4.1 检索智能体 (Retrieval Agent)
*   **职责**：基于用户需求，从向量数据库中提取相关的领域知识。
*   **输入**：“计算夏季主机开启数量，需要手自动切换。”
*   **动作**：检索 `swInput` (模拟量输入), `compare` (比较模块), `switch` (切换模块) 的定义文档及类似案例。
*   **输出**：包含节点元数据和用法示例的上下文 (Context)。

### 4.2 规划智能体 (Planning Agent)
*   **职责**：拥有控制逻辑专家的思维，将需求转化为逻辑步骤。
*   **输入**：用户需求 + 检索到的上下文。
*   **动作**：使用思维链 (CoT) 拆解任务。
    *   *Step 1*: 读取湿球温度。
    *   *Step 2*: 定义5个温度阈值。
    *   *Step 3*: 将当前温度与阈值比较，结果累加。
*   **输出**：结构化的伪代码或 YAML 规划方案。

### 4.3 编码智能体 (Coding Agent) **[核心]**
*   **职责**：将规划方案转化为可执行的 Python 代码。
*   **约束**：必须调用 **Kong SDK**，严禁臆造代码。
*   **输入**：规划方案 + SDK 类定义。
*   **输出**：一段 Python 脚本。
    ```python
    # 示例
    flow = FlowBuilder()
    temp = flow.add_node("swInput", "湿球温度")
    logic = flow.add_node("compare", "比较逻辑")
    temp.connect(logic)
    ```

### 4.4 执行工具节点 (Execution Tool)
*   **职责**：非 AI 节点，作为代码沙箱。
*   **动作**：运行编码智能体生成的 Python 代码。
*   **输出**：
    *   成功：返回生成的 JSON 字符串。
    *   失败：返回 Python Traceback (报错堆栈)。

### 4.5 验证智能体 (Validation Agent)
*   **职责**：双重质检。
    1.  **形式化验证**：检查是否存在悬空节点、未连接的端口、数据类型不匹配（通过 SDK 元数据检查）。
    2.  **语义验证**：由 LLM 检查生成的逻辑是否覆盖了用户的原始需求（如“是否遗漏了安全限值保护？”）。
*   **输出**：Pass/Fail 标志及详细的验证报告。

### 4.6 调试智能体 (Debugging Agent)
*   **职责**：故障修复。
*   **输入**：错误日志 (Traceback) 或 验证失败报告 + 原始代码。
*   **动作**：分析错误原因，生成修复补丁（Revised Code）。
*   **输出**：修正后的 Python 代码，并增加迭代计数器。

---

## 5. 核心基础设施：Kong SDK 设计

这是系统成功的基石，用于屏蔽底层复杂性。

```python
class KongNode:
    """代表一个功能块节点"""
    def __init__(self, type, name, **params):
        self.id = generate_uuid()  # 自动处理ID
        self.type = type           # 对应JSON中的type
        self.params = params       # 对应内部属性
        self.wires = []            # 自动管理连线

    def connect(self, target_node, out_port=0, in_port=0):
        """建立连接，自动处理 wires 数组结构"""
        # 内置校验：检查端口是否存在
        pass

class FlowBuilder:
    """画布管理器"""
    def export_json(self):
        """
        1. 执行自动布局算法 (Auto-Layout)，计算 x,y 坐标
        2. 序列化为 KONG CUBE 标准 JSON
        """
        pass
```

---

## 6. 项目实施步骤

### 阶段一：基础设施构建 (Foundation)
1.  **SDK 开发**：完成 `kong_cube_sdk` Python 库的开发，实现节点定义、连线管理、自动布局算法。
2.  **知识库建设**：
    *   整理 KONG CUBE 所有功能块的 API 文档。
    *   收集 20-50 个高质量的 JSON 组态文件，清洗并存入向量数据库。
    *   编写 Few-Shot Prompt 示例。

### 阶段二：智能体开发与流程跑通 (MVP)
1.  **单链路打通**：实现 Retrieval -> Planning -> Coding -> Execution 的线性流程。
2.  **初步验证**：确保系统能针对简单的指令（如“创建一个 PID 控制回路”）生成合法的 JSON 文件，且该文件能成功导入 KONG CUBE。

### 阶段三：闭环与增强 (The Loop)
1.  **引入验证与调试**：开发 Validation Agent 和 Debugging Agent。
2.  **LangGraph 编排**：配置条件边缘（Conditional Edges），实现错误自动回滚与重试机制。
3.  **复杂场景测试**：使用“夏季主机开启”等复杂案例进行压力测试，优化 Prompt。

### 阶段四：交付与工程化 (Delivery)
1.  **前端开发**：构建 Streamlit 界面，提供对话窗口和文件下载功能。
2.  **人工审核接口**：在最终输出前增加 Human-in-the-Loop 环节，允许工程师微调生成的代码。

---

## 7. 预期成果

1.  **智能体系统**：一套基于 LangGraph 的可运行后端服务。
2.  **SDK 工具包**：`kong_cube_sdk`，即使不使用 AI，工程师也可以用 Python 编写组态。
3.  **知识库**：结构化的楼宇自控领域知识向量库。
4.  **效率提升**：将复杂逻辑的组态时间从小时级缩短至分钟级，且能够保证基础逻辑的零错误率。